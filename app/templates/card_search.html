{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}Kartensuche{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Kartensuche</h1>
    <button class="btn btn-secondary d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
        Filter anzeigen
    </button>
</div>

<!-- Filter Formular (ausklappbar auf Mobile) -->
<div class="collapse d-lg-block" id="filterCollapse">
    <form method="GET" action="{{ url_for('main.card_search') }}" class="row g-3 mb-4 p-3 border rounded bg-dark-subtle">
        <div class="col-12 col-lg-3">
            <input type="text" name="name" class="form-control" placeholder="Kartenname..." value="{{ request.args.get('name', '') }}">
        </div>
        <div class="col-12 col-sm-6 col-lg-2">
            <select name="type" class="form-select">
                <option value="">Alle Typen</option>
                {% for type in types %}
                    <option value="{{ type.id }}" {% if request.args.get('type') == type.id|string %}selected{% endif %}>{{ type.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <select name="set" class="form-select">
                <option value="">Alle Sets</option>
                {% for set in sets %}
                    <option value="{{ set.id }}" {% if request.args.get('set') == set.id|string %}selected{% endif %}>{{ set.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-12 col-sm-6 col-lg-2">
            <select name="rarity" class="form-select">
                <option value="">Alle Seltenheiten</option>
                {% for rarity in rarities %}
                    <option value="{{ rarity.id }}" {% if request.args.get('rarity') == rarity.id|string %}selected{% endif %}>{{ rarity.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-12 col-sm-6 col-lg-2">
            <button type="submit" class="btn btn-primary w-100">Filtern</button>
        </div>
    </form>
</div>

    <!-- Kartenanzeige -->
    <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-3">
        {% for card in cards.items %}
            <div class="col">
                <div class="card h-100 text-center">
                    <a href="#" 
                       data-bs-toggle="modal" 
                       data-bs-target="#cardDetailModal" 
                       data-card-url="{{ url_for('main.card_modal', card_id=card.id) }}">
                        <img src="{{ url_for('static', filename=card.image_path) }}" class="card-img-top" alt="{{ card.name }}">
                    </a>
                    <div class="card-body p-2 d-flex justify-content-between align-items-center">
                        <h6 class="card-title fs-sm mb-0 text-truncate">{{ card.name }}</h6>
                        <!-- Button-Container neben dem Kartennamen -->
                        <div class="collection-button-container">
                            {% if current_user.is_authenticated %}
                                {% if card.id in user_collection_ids %}
                                    <form action="{{ url_for('main.remove_from_collection', card_id=card.id) }}" method="POST" class="d-inline collection-form" data-card-id="{{ card.id }}">
                                        <button type="submit" class="btn btn-danger btn-sm" title="Aus Sammlung entfernen"><i class="bi bi-dash-lg"></i></button>
                                    </form>
                                {% else %}
                                    <form action="{{ url_for('main.add_to_collection', card_id=card.id) }}" method="POST" class="d-inline collection-form" data-card-id="{{ card.id }}">
                                        <button type="submit" class="btn btn-success btn-sm" title="Zur Sammlung hinzufÃ¼gen"><i class="bi bi-plus-lg"></i></button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <p>Keine Karten gefunden, die den Filterkriterien entsprechen.</p>
        {% endfor %}
    </div>

    <!-- Paginierung -->
    {% if cards.pages > 1 %}
    <nav class="mt-4 d-flex justify-content-center">
        {{ macros.pagination_widget(cards, 'main.card_search', args=request.args) }}
    </nav>
    {% endif %}
{% endblock %}